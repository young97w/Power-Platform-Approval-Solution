### 审批包使用说明

1.组成

主实体（标准表）+审批任务（活动）+审批流程配置（标准表）+审批人（标准表）+Automate

主实体作为审批主表单，记录需要被审批的信息，审批任务作为子任务可被不同的审批表单复用。

2.流程处理

审批主表单提交或审批任务完成时，Automate则根据审批流程来停止审批、或者新建审批任务并分配给对应审批人。

3.显示控制

为了提高用户使用体验，在审批任务中，脚本根据不同的审批类型控制显示不同的标签页。



### 增加审批流程步骤：

### 1.新建审批主实体时，需要勾选开启活动。

![勾选活动](.\pictures\勾选活动.png)

### 2.配置日程表/时间线

![时间线配置](.\pictures\时间线配置.png)

将日程表插入窗体中，并且开启审批任务显示。



### 3. 配置审批任务

为了显示对审批主表单应标签页，需要配置单选approvaltype和主窗体。

#### 3.1 在单选approvaltype中新增一个选项，并复制数值。

![配置approvaltype](.\pictures\配置approvaltype.png)



#### 3.2 配置审批任务标签页

新建一个标签页，编辑完页面内容后将名称属性更改为上一步中复制的单选数值，并隐藏标签页。原理：脚本会根据审批类型的选项值显示名称相同的标签页。

![tab配置](.\pictures\tab配置.png)

效果如下：

![根据对应审批类型显示标签页](.\pictures\根据对应审批类型显示标签页.png)

### 4  配置Automate 流

新增一个审批流程时，需要建立两个Automate 流，更改一个Automate 流

新增：

1. 当主表单状态为提交时触发流，生成审批任务。
2. 当审批任务结束时根据结果和流程终止审批或者新建审批任务并分配给下一级审批人。

修改：

1. 审批任务结束时，根据审批类型调用不同子流。

注意：所有的Automate 流均需要新建在同一个解决方案中。

#### 4.1 当主表单状态为提交时触发流，生成审批任务：

1.新建一个自动云端流，并监控状态描述字段。

![触发审批](.\pictures\触发审批.png)

2.获取开启的相关审批任务，如果存在为完成的审批，则终止流。

![获取开启的相关任务](.\pictures\获取开启的相关任务.png)



3.获取相关审批人

首先获取审批流程，再根据审批流程的id值和审批顺序1来获取对应审批人。

![获取相关审批人](.\pictures\获取相关审批人.png)

4 新建审批任务并更改主表单状态

新建审批任务，选择对应审批类型，将获取的审批人赋值到负责人，关联主表单。

<img src=".\pictures\新建审批任务.png" alt="新建审批任务" style="zoom:90%;" />

更改主表单状态到审批中。

![主表单审批中](.\pictures\主表单审批中.png)

#### 4.2 当审批任务结束时根据结果和流程终止审批或者新建审批任务并分配给下一级审批人

1新建一个即时触发流，也就是通过按钮触发的流。并添加调用的参数。

1. regardingid：主表单的id
2. subject：主题，新建任务时使用
3. order：审批顺序，判断审批流是否结束或筛选下一级审批人
4. statuscode：状态描述，用来判断审批结果

![即时触发流](.\pictures\即时触发流.png)

2判断审批结果

如果为拒绝或者取消，则更改主表单状态为拒绝或取消。返回给调用的主流http状态码，并结束流。

![判断审批结果](.\pictures\判断审批结果.png)

3 获取审批人

筛选下一级审批人

![获取审批人加一](.\pictures\获取审批人加一.png)

如果返回空值，则更改主表单状态为已通过，返回http状态码给主流，结束审批流程。

![获取审批人并判断](.\pictures\获取审批人并判断.png)



4 如果审批未结束，则新建审批任务，选择对应审批类型，将获取的审批人赋值到负责人，关联主表单。响应主流。

![新建审批结束流程](.\pictures\新建审批结束流程.png)

#### 4.3 审批任务结束时根据审批类型调用子流

1当审批任务的状态改变时，触发流。

![审批任务完成](.\pictures\审批任务完成.png)

2根据审批类型调用子流

![根据类型调用](.\pictures\根据类型调用.png)